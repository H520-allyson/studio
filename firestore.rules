rules_version = '2';

/**
 * FIRESTORE SECURITY RULES - PRINT GENIE
 * 
 * Core Philosophy:
 * This ruleset implements a flexible access model that supports public-facing features 
 * (shop branding, order placement, and tracking) while strictly securing administrative 
 * operations (managing all orders and shop settings).
 */

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    /**
     * @description Checks if the request is from a signed-in user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Determines if the authenticated user has administrative privileges.
     * Relies on the existence of a document in the 'roles_admin' collection.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    // --- Collection Rules ---

    /**
     * @description Administrative roles registry.
     */
    match /roles_admin/{userId} {
      allow get: if isSignedIn() && request.auth.uid == userId;
      allow list, create, update, delete: if isAdmin();
    }

    /**
     * @description Stores global shop settings like currency, logo, and pricing formulas.
     * Public get is allowed so the landing page and calculator can display shop info.
     */
    match /shop_configuration/{shopConfigurationId} {
      allow get: if true;
      allow list, create, update, delete: if isAdmin();
    }

    /**
     * @description Stores customer orders for printing services. 
     * - Public 'get' allows customers to track status with their reference number.
     * - Public 'create' allows anyone to place an order.
     * - 'list', 'update', and 'delete' are restricted to admins.
     */
    match /orders/{orderReferenceNumber} {
      allow get: if true;
      
      allow create: if request.resource.data.orderReferenceNumber == orderReferenceNumber;

      allow list, update, delete: if isAdmin();
    }

  }
}